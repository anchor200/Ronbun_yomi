# MaxEnt,SDM,Species distribution models,review,tutorial <br>
# MaxEntの解説．presense-only dataを扱う注意点から，具体例まで書いてある．<br>
<script src="../library/marked.min.js"></script>
<link rel="stylesheet" type="text/css" href="../library/index.css">
<head>
<title>
Elith, J., Phillips, S. J., Hastie, T., Dudík, M., Chee, Y. E., & Yates, C. J. (2011).A statistical explanation of MaxEnt for ecologists.Diversity and distributions, 17(1), 43-57.</title>
</head>
<body>

<font size="5"> 
Elith, J., Phillips, S. J., Hastie, T., Dudík, M., Chee, Y. E., & Yates, C. J. (2011).A statistical explanation of MaxEnt for ecologists.Diversity and distributions, 17(1), 43-57.</font>
<a href="https://onlinelibrary.wiley.com/doi/full/10.1111/j.1472-4642.2010.00725.x">https://onlinelibrary.wiley.com/doi/full/10.1111/j.1472-4642.2010.00725.x</a>

<script>md(`


## Introduction

<div class="box1">
<p>
種分布モデリング (Species distribution modesl: SDM) とは，<b>種の記録</b>（在と不在のどちらか，または両方）と<b>調査区域の環境変数や空間的特徴</b>の間にある関係を推定することである．近年，生物地理学や生物や生態系の保全に用いられている．
</p>
<p>
在と不在両方のデータが使用可能であれば，回帰モデル（一般化線形モデルGLMや一般化加法モデルGAM），アンサンブルモデル（ランダムフォレスト，ブースティング回帰木）を使用することができる．しかし，システマティックに得られた在-不在データが利用可能であることは一般に少ない．このような場合には，在のみのデータが持つ様々なバイアスや制限に対応できる手法を用いる必要がある．そのような中で良い性能を持つ手法として，MaxEntが知られている．
</p>
<p><font size="2" color="888888">[memo] 在-不在がどちらも利用可能であれば，MaxEntの使用は推奨されていない．
</font><p>
<p><font size="2" color="888888">[memo] MaxEntの利用例は，<a href="http://www.prbo.org/">Point Reyes Bird Observatory online application</a>，<a href="http://www.ala.org.au/">Atlas of Living Australia</a>など
</div></a>
</font><p>



## 在のみ (presence-only) データはなぜ特別なのか？


<div class="box1">

<p>在のみデータでの分布モデリングに関して盛んに議論されているのは，どのような種類の分布が推定されるのかというトピックである（例えば，潜在分布か実現分布か）．
この問題が難しいのは，<b>データの質，モデリング手法，分析スケール</b>という複数の要素が相互作用しているからである．</p>

<p><font size="2" color="888888">[memo] データの質：種に関するデータの量と正確性，説明変数の信頼性・生態学的妥当性，撹乱・分散制限・生物間相互作用に関する情報が使えるかどうか．
</font><p>
</p>

<p>
文献でも議論されているように，在のみデータを用いることで，不在データの信頼性に関する問題から開放されるような気がする．以下のような論点がある：不在データは，生物間相互作用（競争排除）撹乱，分散制限の働きを強く反映するために，在-不在両方を用いた場合には，「潜在分布」の推定を不可能になる（在のみしか用いなければ，そのような心配がない）．<br><br><b>しかし</b>，在のみデータであっても，種の不在記録を生じさせる様々な要因に影響を受ける．種がいない場所では在は記録されないのだから，撹乱や競争の影響で種がいない場所では，（環境としては生息適地であっても）不適地であるとみなされ，それが分布推定に影響する．さらに，種を見つけにくいサイトがあれば，在-不在データにおける不在記録が生じやすくなるのと同時に，在のみデータの構造にも影響する．<br><br>以上から，<b>在のみデータを用いることが，不在データを用いることによる制限からの開放を意味することはない</b>．在のみデータでモデリングされるのは，在-不在データを用いる場合と同じように，<b>種の在確率 the probability of presence of a species</b>である．
</p>
<br>

#### 問題の定式化

<p>
以下では，研究者が利用可能なデータは在のみ（y=1が在，y=0が不在=在ではない）であるとし，調査区域L上にあるとする．ベクトルzは，調査区域すべてあるいはそこからのランダムサンプル地点における，複数の環境変数および共変量を表す．zは関心がある全ての場所で利用可能であるとする．<br><br>
f(z)を，共変量のL上での確率密度関数，f1(z)を，L中で在データがある領域上での共変量の確率密度関数，f0(z)を不在領域での確率密度関数と定義する．
<br><font size="2" color="888888">注：確率密度関数は，ある状態が観測される相対的尤度を意味する</font>．<br><br>
ここで推定したいのは，Pr( y=1 | z )つまりある環境変数が与えられたときの条件付き在確率．ベイズの定理により，f(z)とf1(z)があれば，Pr( y=1 | z )は以下のように書ける．
<br><br>
<b><font color="blue">Pr( y=1 | z ) = f1(z) × Pr( y=1 ) / f(z) </font></b>
<br><font size="2" color="888888">注：Pr( y=1 ) と f(z) は独立ではないため，Pr( y=1 ∧ z ) = f1(z) × Pr( y=1 ) となる．f1はconditional density．∫_L f1×Pr(y=1) = f</font>
<br>
</p>
<p>
よって，<b>Pr( y=1 ) がわかればいい</b>ことになるが．これは在のみデータからはわからない（不在データが使えても，一般に，正しく推定することは難しい）．
</p>
<br>

#### 在のみデータのサンプルバイアス

<p>
次の問題：在-不在データを用いた場合よりも，<b>在のみデータではサンプルバイアスの影響がずっと大きい</b>．対象的に，在-不在データであれば，サンプル努力に起因するバイアスは合理的な仮定のもとで相殺される (Zadrozny, 2004)．
<br><font size="2">f1(z)が，サンプル努力s(z)によってバイアスされている場合を考える．このようなバイアスは，地理的要因や環境要因（入りにくい崖など）によって生じる事が多いが，いずれにせよf1(z)の構造に影響する．このとき環境変数の分布は，s(z) × f1(z)という形でしか得られない（sとf1がzについて独立な場合は積，そうでないならもっと複雑）．</font>
</p>
<br>


#### 在のみデータの解釈

<p>
さらに，在-不在を単純に2値変数として定義することはできない．この点について，<b>在のみデータは，在-不在データとはっきりと異なる</b>．種が存在するかは，時空間スケールに影響される．鳥のように移動能力が高ければ，同じ場所でも在が記録される時とそうでない時があるだろう．植物は，同様の条件であればより広いサイトで在が観測されやすい（周囲1km四方に特定の植物種が存在しなければ，周囲1m四方にもいないが，逆は正しくない）．
<br><br>在-不在データであれば，不在が記録されている範囲を見れば，時空間スケールがわかるが，在のみデータであればそれが読み取れない（そのため，在をどんなスケールで定義すればいいのかがわからない）．
<br><br>
ゆえに，環境変数を定義する際に問題が生じる．在-不在データであれば，サンプル方法から読み取れる時空間スケールで定義すればよく，そのスケールで在-不在の0/1も定義できる．しかし，在のみであればそれができないことが多い．環境変数のスケールに合わせて在-不在のスケールが定義されてしまうことも多い．
</p>
<br>


#### 不在データが使える場合

<p>
在のみデータと環境変数があれば，Pr( y=1 ) がわかれば在-不在データと同じように分布推定ができる．しかし，在-不在データがある場合には，それらの情報を両方使う分布モデリング手法を用いたほうがよい（正確な推論を可能にするためにモデルが満たさなければならない特性を，データから読み取ることができるからである）．
</p>
<br>

</div>



## MaxEntの解説


see also <a href="https://plantarum.ca/notebooks/maxent/">MaxEnt Best Practices</a>

<div class="box1">

### 共変量と特徴量

<p>
生態学のモデリングでは，独立変数は共変量，予測変数，入力などと呼ばれる．SDMでは，これらは生息適度に関する変数からなる（気候推定値，起伏，土壌，温度，塩分濃度，獲物の量，etc. ）．このような変数と目的変数の関係は複雑なので，通常は非線形関数によってモデリングされる．このとき，logやスプライン，多項式や傾きが変わる線形関数によって変換される．このように変換された値を，機械学習では特徴量と呼ぶ（この意味で，特徴量とは共変量の変換・拡張された集合；交互作用も特徴量の1つとなる）．<br><br>
ゆえに，MaxEntによる推定では，ほとんどの場合に共変量よりも多くの特徴量が使われる．現在使用可能な特徴量のクラスは以下．
<ul>
<li>Linear</li>
<li>Quadratic</li>
<li>Categorical</li>
<li>Products: 2変数間での可能なすべての積（単純な交互作用の推定）</li>
<li>Threshold: 階段関数</li>
<li>Hinge: 傾きが変わる直線（GAMで使われる線形スプラインと近い）</li>
</ul>
<p>
<br>

### MaxEntの概要

<p>
MaxEntを地理的空間上での確率分布の推定とみなした解説があるが (Phillips et al., 2006; Phillips & Dudík, 2008) それとは異なるアプローチで解説する（もちろん同値である）．
<br><br>
上で見たように，Pr( y=1 ) すなわち調査区域全体での在確率がわかれば，環境変数に条件付けられた種の分布確率がわかる．これを求めるために以下の手続きを行う．まず，η(z) = log ( f1(z) / f(z) ) を計算する．そして，z_tを，η(z_t) = ∫ η(z) dz となる点（Lの中での"typical"な環境条件）と定義し，logistic( η(z_t) ) + C = τ となるように切片を調整する．最初，τ=0.5として計算する．このように校正 (calibrate) することによって，Pr( y=1 ) が計算可能になる．
<br><font size="2" color="888888">
注：このような何らかの仮定を置かなければ，原理的に在のみデータから在割合 (Prevalence) を得ることは不可能である．</font><br>
</p>
<br>

<p>

#### 背景データ・種分布データ

以下では，Lを調査区域全体，L1 (&sub; L)をpresentな点の集合とする．Lは種の分散が及ぶ範囲など，生態学者が意味を込めて決める．Background sample: Lからの有限のランサムサンプルにより，L中のCovariateの分布を計算する．このとき，LからのサンプルはL1に含まれる点を含むこともある．また，Presence dataのある点は，L1からのランダムサンプルであると仮定する．
</p>
<br>

<p>

#### モデルの概要

MaxEntは，f1(z) / f(z) を推定するが，この際，L1のデータ点と一貫し，かつ f(z): null model に最も距離の近い分布を分布として f1(z) を推定する．この距離：KL divergence. 例：雨量がCovariate（説明変数）だとすると，f1(z) のもとでの雨量の平均値は在データ点の雨量の平均とが最大限近くなるという制約のもとで，f(z) のKL divergenceを最小化するような f1(z) を選ぶ．
<br><font size="2" color="888888">注：他の説明では，推定するものを raw distribution π(x) = Pr( x | y=1 ); 種が在だという条件のもと，それが点xで生じる確率，と記述していた．この際に，π(x) のエントロピーが最大になるような制約をかける（≒ 一様分布に近くなる）が，これは上記のfとf1のKL divergenceを最小化することと同値（双対問題）．<br>
注：MaxEntでは，説明変数だけではなく，説明変数を変換した値を用いることができる．変換した場合には平均値が変わることもあるため，制約条件の効き方も異なってくる．</font>．<br><br>
KL距離の最小化を行うと，以下の正規分布の形で解が得られる．<br><br>
<b><font color="blue">f1(z) = f(z) × exp( η(x) ) ただし η(x) = [正規化項] + 係数ベクトルβ • 説明変数ベクトルh(z)</font></b> <br>

</p>
<br>

<p>

#### 推定の方法

MaxEntの計算で求めたいのは exp( η(x) )  である．このとき，過剰適合を防ぐために，説明変数ごとにデータとの許容誤差パラメータを設定し（λ × 説明変数の標準誤差），L1正則化を行う（L1正則化は，尤度関数に1-ノルムを罰則項として入れることに相当し，この下での尤度最大化は，λの誤差を許容した下でのKL divergence最小化と同値）．λは，よく使われる設定では，特徴量のクラスごとに国際的分布データを用いてデフォルトが設定してある（226種，6地域，11-13特徴量を使っている；ゆえに，より多くの特徴量を入れる場合には，λをデフォルト値から変えるほうがよい場合もある）．
</p>
<br>

#### Logistic output

<p>
MaxEnt (version 3 以降) が吐く Logistic output は，本来計算できない在確率を，様々な仮定をおいて計算しているものである．ただし，raw outputとの関係は単調であるため，順位は保存される．最初の定式化に戻ると，種の在確率は，<br><br><b><font color="blue">Pr( y=1 | z ) = f1(z) × Pr( y=1 ) / f(z)  =  exp( η(x) ) × Pr( y=1 ) </b></font><br><br>と書ける．しかし，指数関数は外挿したときにとんでもない値に発散してしまうなど良くない振る舞いをするので，logistic 変換により在確率を得る．すなわち，<br><br><b><font color="blue">Pr( y=1 | z ) = τ × exp( η(x) - r ) / ( 1-τ + τ × exp( η(x) - r )  )</b></font><br>ただし r は f に対する f1 のエントロピー比，τ は最も典型的な環境での在確率；デフォルトで0.5．<br><br>と計算する．この関係式はロバストベイズアプローチのミニマックス法から導出されたものである．exp( η(x) ) が小さいと，ほぼ exp( η(x) ) / (1 - τ) になり，exp( η(x) ) が大きいと，1に近づく．経験的に，τ=0.5 としたときの結果は，raw output を使うよりよい結果になることがわかっている (Phillips & Dudík, 2008)．
<br><font size="2" color="888888" >注：Lの中で「典型的な場所」の在確率を0.5とするということは，Background data に明らかに種がいない場所を大量に含んでしまうと結果がおかしくなることを意味する．</font><br>
<br>
<br>ここで重要なのは，Prevalence つまりサンプル中の在ポイントの割合 Pr( y=1 ) は，サンプル方法やサンプル努力の影響を受けることである．在データのみであれば，これは必ずしも明示されていない．もし，サンプル方法が分かるなどし，調査区域全体の Prevalence がわかれば，その値を用いて τ を校正することもできる．<br>
</p>
<br>


#### モデリング上の注意点

<p>

##### バイアスとの戦い<br>

MaxEntはバイアスのないデータを仮定する．ゆえにデータのミスや重複は除くべき．また，サンプリングにバイアスがある場合には，同じようなバイアスを持つような Background data を用いる：同じ研究グループが行った別の生物群の調査点など．あるいは，サンプル努力の分布を表したグリッド bias grid を用意する．また，緯度経度グリッドのように，グリッドごとの面積が異なる場合には，自分でグリッドを置き直すか，それぞれの面積を表したグリッドを bias grid とするなどして，それを補正する必要がある．
<br><font size="2" color="888888">注：この辺の話は，MaxEntのマニュアルにも書いてあるらしい．</font><br>
</p>
<br>



<p>

##### Backgroud data の選定<br>

MaxEntの結果は，背景データに左右される．背景データは，種の range の全てに渡っている必要がある．一方，種の分散能力を越えた領域や，全く調査されていない領域は（いるかわからないから調査されていない，という場合を除いて）背景データから排除すべき．また，ハビタットが存在しないことが確実であるために調査されていないであろう場所も排除すべきである．
</p>
<br>


<p>

##### 特徴量の選定<br>

線形は常に用いてよい．二次は10サンプル以上，ヒンジは15，階段関数と2変数の積は80以上のサンプルのときに使う．また，サンプルが少ない場合には生態学の知識に基づいて変数を選択するとよい．線形特徴量と階段関数の組み合わせの代わりにヒンジ特徴量のみを用いるとスッキリすることもある（この場合，一般化加法モデルGAMに似た感じになる）．積を入れると複雑なモデル化ができるが，解釈可能性が落ちる．<br><br>
デフォルトで行われるL1正則化は性能がいいので，他の事前処理はしなくていい（例：PCAや多重共線性に基づく変数選択）．ただし，多くの変数を考慮する場合には生態学の知識に基づいて変数選択をするのは良い．別の地域や気候帯で結果をマップする場合には，どちらでも使える proximal variable を選ぶのが重要．平滑な結果を得たいのであれば．λを大きくするのがよい．
</p>
<br>

<p>

##### 種間比較の解釈<br>

MaxEntの Logistic output は与えられたデータのサンプル努力のもとでの在確率の近似である．そのため，異なる種についての値を比較することはあまりよくない．

</p>
<br>

<p>
</p>
<br>

</div>

## 使用例その1

<div class="box1">


<p>
Banksi prionotes（バンレイシ科）の分布推定，および将来の分布域の変化予測．
<br>
確認する点<br>

<ul>
<li>landscapeの選択</li>
<li>調査バイアスへの対応</li>
<li>非等面積グリッドの調整</li>
<li>少ない特徴量でsmoothなモデリング</li>
<li>別の場所，時間の環境を評価するツール</li>
</ul>
</p>
<br>

<p>

#### データ

Banksia Atlas (Taylor & Hopper, 1988; Yates et al., 2010); 361 records / 4361 sites across South West Australia Floristic Region (SWAFR)

<br><br>
これらを，presence-only data と解釈して分析する．Backgroundは3通り考える．1) Banksia Atlas の全ての調査点をbackgroundとする．2) SWAFRからランダムに10,000サイト．3) オーストラリア全体から20,000サイト．<br><br>
2) では，在データがFR内の「全ての」在地点からのランダムサンプルであることを暗黙に仮定する（FR内は農地になっているところが多く，パッチ状に分布した適地っぽいところからのサンプルであるため，この仮定は正しくなさそう＝調査地以外にも在の場所がある可能性が高い）．3)では，種がオーストラリア全域に分散できることが仮定される．すべての環境を網羅できる（外挿が起きにくくなる）．しかし，北部・東部にはバリアになりそうな砂漠があるので，この仮定も正しくなさそう．
</p>
<br>


#### モデル

<p>
先行研究を元に，以下の変数を使用．全てHinge feature. <br><br>
温度の違いisothermality (ISOTHERM), 最湿月mean temperature of the wettest quarter (TEMPWETQ), mean temperature of the warmest quarter (TEMPWARMQ), annual precipitation (RAIN) and precipitation of the driest quarter (RAINDRYQ), and an estimate of the solum plant-available water-holding capacity (SOLWHC); 将来の予測は，A1FI シナリオの2070年．土壌のデータは現在と同じと仮定（実際に未来への投影を行うには，土壌や土地利用の変化についてもっと詳細なデータが必要）
</p>
<br>

<p>
モデルの当てはまりを計算＋cross-validationを行う．注1：cross-validationは異なるbackground条件間では比較できない（変数選択とかの比較用）．注2: AUC（応答曲線の下面積）は在とbackground (=偽不在) に対して計算される．
</p>
<br>

#### 結果
<p>
1) Atlas background の場合は，分布が東寄りに推定されている．これは実情とよく合っている．Study siteは海側に偏っているが，Atlas backgroundを使うことでこの影響が抑えられている（不在の調査点しか，backgroundに入れていないから）．変数にかかっている重みも1)-3)で異なる．それぞれのbackground設定は，異なる問いに対応している；全オーストラリアなら，なぜこの種は南西オーストラリアにしか現れないのか？と問うていることになる．
</p>
<figure><img src="Images/Elith_etal_2011/result.gif" width="400"><figcaption>
background選択による現在の推定，未来への投影，未来に未知環境がどれだけ生じているか．</figcaption></figure><br>
<br>
<p>
外挿には注意を払うべき．MaxEntには，外挿が起きたことで推定値の不確実性が高い点を教えてくれる．新しい環境がどれくらいあるかを見るには，MESS maps, multivariate environmental similarity surfaces が有用．ところで，1)よりも2)と3)のほうが，未来に投影したときに未知の環境が少ない．これはより広い環境勾配に従ってbackgroundをとったからである．注意すべきは，このように外挿が少ないことは，良い推定を生むことを意味しないことである．

</p>
<p><font size="2" color="888888">[memo] clamping: the process by which features are constrained to remain within the range of values in the training data. 訓練データに現れなかった環境に対して外挿による投影をしない（訓練データにあった最も極端な環境に対する予測値で置き換える）．
</font><p>
<br>

<p>
興味深いのは，model 3が一番10-fold cross-validated AUCの結果が良いこと；最も生態学的な根拠がないbackground選定であるにも関わらず（だから，意味のある好成績ではない）．<br><br>
全オーストラリアを背景とした場合，TEMPWETQの説明力が高い：この変数が，在データがある調査区域を全オーストラリアに対して特徴づける変数になっている．
<br><br>
backgroundを局所的にすることで，より生態学的に意味があり，managementにも使えるような結果が得られる．一方，大きいエリアに外挿する際には外挿が起きやすくなる（トレードオフ）．
</p>
<figure><img src="Images/Elith_etal_2011/table3.png" width="400"><figcaption>
background選択による変数の説明力の違い．</figcaption></figure><br>

<br>

</div>

## 使用例その2

<div class="box1">


#### データ

<p>
Gadopsis bispinosus, きれいな山がちな川に住む魚．<br><br>注：在のみデータとbackground (L) があれば，在-不在データを使用した場合と，対象区域L中の在確率つまり Pr( y=1 ) が同じという条件下で，同じ量の推定ができる．ゆえに，在-不在データがある場合と同じようなデータが使えるほうがいい．今回は，川の推定なので，グリッドの環境データではなく，川の形に沿った詳細なデータを使うことが有効になる
</p>
<br>


#### モデル化

<p>
SWD (samples-with-data) フォーマットを使う．川のvectorデータで考える（変数を，グリッド化された離散量ではなく，川の形に沿った連続量として考える）．<br><br>
20変数を候補に；空間変数は3つの階層スケール segment, immediate watershed and entire upstream catchment area と下流域についてまとめたもの；環境変数は，climate, river slope, riparian vegetation and catchment characteristics を使用；水系も離散変数として入れ，環境要因では説明できない部分を定量化する．

</p>
<br>


#### 結果

<p>
大きく山がちな川が適地であるという結果になった．jacknife test の結果，一番影響が大きい変数は以下；summed length of all upstream links (TOTLENGTH_UCA), the upstream maximum slope (US_MAXSLOPE) and the amount of riparian tree cover upstream (UC_RIP_TRECOV)．他の変数が持っていない情報を一番多く持っていたのは，maximum temperature of the warmest month (MAXWARMP_TEMP).

<figure><img src="Images/Elith_etal_2011/result2.gif" width="400"><figcaption>
適地推定結果のプロット</figcaption></figure><br>
<br><br>
cross-validationには，川ごとに除いて行うという方法もあり得る（今回は，在ポイントが一部の川に集中していたのでやらず）．

</p>
<br>


<p>
</p>
<br>
</div>


`)</script>
2022/03/18 レジュメ作成：五十里
<a href="../index.html">return to index</a>









</body>